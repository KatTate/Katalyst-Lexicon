# Epic 7: Administration & Governance — Retrospective

Date: 2026-02-15
Facilitator: Bob (Scrum Master)
Epic: 7 — Administration & Governance
Status: Complete (5 stories done — all ACs met except 2 documented deferrals)

## Epic Summary

Epic 7 delivered the complete administration and governance layer for Katalyst Lexicon — enabling role-based access enforcement via Replit Auth (OIDC with Google sign-in), user management with role promotion/demotion, category CRUD with color picker and reordering, principles authoring with markdown preview and term linking, and system settings with auto-save toggles. The epic also replaced all hardcoded mock user identity with real authenticated identity throughout the application.

The key architectural decision — implementing Story 7.5 (auth foundation) first, per the Epic 6 retro recommendation — enabled all subsequent stories to build on real authentication, real identity, and real permissions from day one.

## Story Completion Profile

| Story | Size | ACs | Files Created | Files Modified | Notes |
|-------|------|-----|---------------|----------------|-------|
| 7.5 Role-Based Access Enforcement | L | 13 (11 satisfied, 2 deferred) | 3 (permissions.ts, middleware/auth.ts, auth module) | 8 | Cross-cutting foundation; schema reconciliation; first-admin bootstrap |
| 7.2 User Management | M | 7 | 0 | 3 | Settings.tsx refactor; invite flow removed; last-admin protection |
| 7.1 Category Management | M | 7 | 0 | 3 | Color picker (hex migration); reorder arrows; delete-with-terms guard |
| 7.3 Principles Authoring | M | 8 | 1 (ManagePrinciples.tsx) | 4 | Markdown preview; term linker; slug uniqueness; server-side owner |
| 7.4 System Settings | S | 6 | 0 | 1 | Auto-save per toggle; "coming soon" note; tab rename |

**Deferred ACs:**
- AC8: Domain restriction (@katgroupinc.com sign-in filter) — Replit Auth OIDC doesn't support domain filtering during development
- AC9: Non-domain email rejection — same root cause as AC8
- **Resolution:** User decided to resolve before Epic 8 while auth code is fresh

## Git Commit Analysis

- Total commits: 29 (including saved-progress checkpoints)
- Fix/correction commits: 0 (0% fix ratio — exceptional)
- Quality improvement commits: 2
- Most-touched source files:
  - `server/routes.ts` — 3 changes (middleware added per story)
  - `Settings.tsx` — 3 changes (7.2 refactor + 7.4 enhancements)
  - `Layout.tsx` — 2 changes (nav filtering + admin links)
  - `ManageCategories.tsx` — 2 changes (features + code review fix)
  - `ManagePrinciples.tsx` — 2 changes (create + code review fix)
  - `api.ts` — 2 changes (new API methods)
- New files created: ~8 (permissions.ts, auth module, middleware, ManagePrinciples.tsx, 5 test files)
- Zero reverts, zero force-pushes, zero burst-commit patterns

## Codebase Health

- LSP errors: 0
- LSP warnings: 0
- TODO/FIXME/HACK markers: 0 (entire project source)
- Net debt markers added: 0

## Code Review Finding Trend

| Story | Findings | Severity | Pattern |
|-------|----------|----------|---------|
| 7.1 Category Management | 4 | 2M, 2L | canAdmin() hardcoded, document.title missing, Browse.tsx LSP warning, reorder race |
| 7.2 User Management | 2 | 2M | document.title missing, AlertDialogCancel autoFocus |
| 7.3 Principles Authoring | 1 | 1M | document.title missing |
| 7.4 System Settings | 0 | — | Clean |
| 7.5 Role-Based Access | 0 | — | Clean |

**Trend:** 4→2→1→0→0 — team internalized AR14 (document.title), AR15 (dialog protection), and permissions.ts patterns across the epic.

## Lessons Learned

### Lesson 1: Foundation-First Ordering Multiplies Epic Velocity

Implementing Story 7.5 (auth) first — based on the Epic 6 retro recommendation — meant all 4 subsequent stories had real authentication, real identity, and real permissions from day one. No story had to mock auth or retrofit it later. This is the strongest evidence that retro action items directly improve outcomes.

**Takeaway:** When an epic has a cross-cutting foundation story, always implement it first. The retro recommendation process works — follow through on it.

### Lesson 2: Shared Utility Files Prevent Cross-Story Drift

`shared/permissions.ts` was created in Story 7.5 and consumed by all subsequent stories without modification. This single source of truth prevented permission logic duplication that plagues many admin systems. The pattern: create the shared utility in the foundation story, consume it unchanged in all subsequent stories.

**Takeaway:** For cross-cutting concerns (permissions, auth helpers, shared types), create a single utility file in the foundation story and import it everywhere. Never duplicate the logic.

### Lesson 3: Code Review Finding Decay Indicates Team Learning

Code review findings decreased from 4→2→1→0→0 across the 5 stories. This isn't because later stories were simpler (7.3 Principles Authoring was complex). The team internalized patterns from earlier reviews — AR14 (document.title), AR15 (dialog protection), `canAdmin()` from permissions.ts — and stopped making the same mistakes.

**Takeaway:** Expect early stories in an epic to surface more review findings. Track the trend — decreasing findings across stories is a health indicator.

### Lesson 4: Integration-First Beats Build-From-Scratch

Using Replit Auth instead of building Passport.js + Google OAuth from scratch saved significant complexity. The only friction was schema reconciliation (existing users table vs. auth integration's users table) — a one-time cost. The integration handled sessions, OIDC flow, user records, and React hooks automatically.

**Takeaway:** When a platform integration exists for a capability, use it. The one-time reconciliation cost is far lower than building and maintaining the capability from scratch.

### Lesson 5: Zero Debt Markers Is Achievable and Worth Maintaining

Epic 7 added zero TODO/FIXME/HACK markers to the codebase. The entire project source has zero debt markers. The only deferred item (domain restriction) was documented in the story record rather than left as a code comment. This is the standard to maintain.

**Takeaway:** Document deferrals in story records, not in code comments. Keep the codebase free of debt markers.

### Lesson 6: Recurring Review Findings Signal Systemic Solutions

AR14 (document.title) was flagged in 3 of 5 code reviews. A `useDocumentTitle` hook would eliminate this entire class of finding. When a pattern appears in 2+ reviews, create a systematic solution rather than fixing each instance individually.

**Takeaway:** After an epic, look at recurring review findings. If a pattern appears 2+ times, build a reusable solution (hook, utility, component) to prevent it in future epics.

## Epic 6 Retrospective Follow-Through

| # | Action Item | Status | Evidence |
|---|------------|--------|----------|
| 1 | Update sprint-status.yaml with Epic 6 retro done | ✅ Done | sprint-status.yaml shows `epic-6-retrospective: done` |
| 2 | Install Replit Auth integration | ✅ Done | Auth integration installed and wired in Story 7.5 |
| 3 | Plan Epic 7 story order (consider 7.5 early) | ✅ Done | 7.5 implemented first, followed by 7.2→7.1→7.3→7.4 |
| 4 | Consolidate carry-forward tech debt | ⏳ Deferred | Appropriate — Epic 8 (Quality) is next |

**Follow-through rate:** 3 of 4 completed, 1 appropriately deferred.

### Epic 6 Team Agreements Applied

| Agreement | Applied? | Evidence |
|-----------|----------|----------|
| Sequential story stacking | ✅ Yes | 5 stories built sequentially: 7.5→7.2→7.1→7.3→7.4 |
| Classify actions by consequences for dialog decisions | ✅ Yes | AR15 applied to delete dialogs in 7.1, 7.2, 7.3 |
| Plan enums ahead when full epic scope is visible | N/A | No new enums created in Epic 7 |
| Document architectural gaps — resolve when right story arrives | ✅ Yes | "Auth not wired" gap resolved by Story 7.5 |
| URL parameters for component mode detection | N/A | No new component modes added |
| Carry forward tech debt to cleanup sprint | ⏳ Deferred | Appropriate — Epic 8 Quality is next |

## Team Agreements

- Continue sequential story stacking — proven effective across Epics 5, 6, and 7
- Create shared utilities in foundation stories, consume in subsequent stories (permissions.ts pattern)
- Use integration-first approach when platform integrations exist (Replit Auth pattern)
- Zero debt marker standard: document deferrals in story records, not in code comments
- Foundation-first ordering: always implement cross-cutting stories before dependent stories
- When a review finding appears 2+ times, build a systemic solution (hook/utility)

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | ✅ Strong | All 5 stories E2E + API tested. All passing. |
| Code Quality (LSP) | ✅ Clean | 0 errors, 0 warnings |
| Tech Debt Trend | ✅ Net zero | 0 new markers. 0 total in source. |
| Git Health | ✅ Excellent | 0% fix ratio, steady cadence, no reverts |
| Domain Restriction | ⚠️ Deferred | AC8/AC9 — resolve before Epic 8 (user decision) |
| Carry-Forward Debt | ℹ️ 5 items | Unchanged from Epic 5/6 — LOW priority |

## Action Items

| # | Action | Priority | Owner | When |
|---|--------|----------|-------|------|
| 1 | Resolve domain restriction (AC8/AC9) | HIGH | Charlie (Senior Dev) | Before Epic 8 |
| 2 | Create `useDocumentTitle` hook | MEDIUM | Charlie (Senior Dev) | Before Epic 8 Story 8.2 |
| 3 | Establish admin-flow E2E testing pattern | MEDIUM | Dana (QA Engineer) | During Epic 8 Story 8.3 |
| 4 | Update replit.md with Epic 7 architecture | MEDIUM | Paige (Tech Writer) | Before Epic 8 |
| 5 | Consolidate carry-forward tech debt | LOW | Team | Cleanup sprint after Epic 8 |

## Epic 8 Preparation Tasks

| # | Task | Owner | Notes |
|---|------|-------|-------|
| 1 | Story 8.2 scope review — many AR14 fixes already done in Epic 7 | Alice (PO) | Likely S→XS |
| 2 | Verify dark mode compatibility of role-based nav filtering | Charlie | For Story 8.1 |
| 3 | Research @axe-core/playwright integration | Dana (QA) | For Story 8.4 |

## Critical Path Before Epic 8

1. **Resolve domain restriction (AC8/AC9)** — production blocker, user chose to resolve now while auth is fresh
2. No other blockers — Epic 8 has no dependencies on unresolved Epic 7 work

## Outstanding Tech Debt

| # | Item | Severity | Source | When to Address |
|---|------|----------|--------|-----------------|
| 1 | `GET /api/principles` bypasses storage layer | MEDIUM | Epic 4 | Before storage refactoring |
| 2 | Extract `useSearch()` hook for DRY | LOW | Epic 1 carry-forward | Cleanup sprint |
| 3 | Replace `<a>` with `<Link>` in search CTAs | LOW | Epic 1 carry-forward | Cleanup sprint |
| 4 | `PrincipleWithCount` type assertion | LOW | Epic 4 | When updating API client types |
| 5 | Toast TOAST_REMOVE_DELAY 1000000ms | LOW | Pre-existing | Cleanup sprint |

## Epic 7 Metrics Summary

| Metric | Value |
|--------|-------|
| Stories completed | 5 |
| Total ACs | 41 (39 satisfied, 2 deferred with documentation) |
| New pages created | 1 (ManagePrinciples.tsx) |
| New shared utilities | 1 (shared/permissions.ts) |
| Auth integration | Replit Auth (OIDC + Google sign-in) |
| Files modified | ~15 across all stories |
| Code review findings | 7 total (4+2+1+0+0 trend — all fixed) |
| LSP errors/warnings | 0 / 0 |
| Tech debt markers added | 0 |
| Fix-to-feature commit ratio | 0% (exceptional) |
| Carry-forward tech debt | 5 items (unchanged from Epic 5/6) |
| Retro action item follow-through | 3/4 (75% — 1 appropriately deferred) |
