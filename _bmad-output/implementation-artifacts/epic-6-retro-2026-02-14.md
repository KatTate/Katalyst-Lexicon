# Epic 6: Review & Approve — Retrospective

Date: 2026-02-14
Facilitator: Bob (Scrum Master)
Epic: 6 — Review & Approve
Status: Complete (4 stories done — all ACs met)

## Epic Summary

Epic 6 delivered the complete proposal review and approval workflow for Katalyst Lexicon — enabling approvers to view a review queue, make approval/rejection/change-request decisions with confirmation dialogs, view a full audit trail of proposal events, and allowing proposers to revise and resubmit proposals based on reviewer feedback. This epic completed the governance chain started in Epic 5 (Propose & Contribute): propose -> review -> approve/reject/revise -> audit.

## Story Completion Profile

| Story | Size | ACs | Files Created | Files Modified | Notes |
|-------|------|-----|---------------|----------------|-------|
| 6.1 Proposal Review Queue | S | ~8 | 0 | 2 | Refined existing ReviewQueue.tsx for oldest-first ordering, empty state, permission checks, data-testid |
| 6.2 Proposal Review and Decision | M | ~12 | 0 | 2 | AlertDialog confirmation, reject/request-changes require reasons, 409 race condition handling, toast messages |
| 6.3 Proposal Audit Trail | L | ~14 | 0 | 5 | New proposalEvents table, storage methods, event recording on all state transitions, timeline UI |
| 6.4 Proposer Revision Flow | L | ~16 | 1 | 7 | Revision mode in ProposeTerm.tsx, resubmit/withdraw endpoints, My Proposals page, change detection |

## Git Commit Analysis

- Total implementation commits: 6 (1 story creation, 1 main implementation, 2 review fix rounds, 1 access controls, 1 docs)
- Main implementation commit: `ef6e50c` — 14 files changed, +746/-114 lines (all 4 stories in one commit)
- Fix/correction commits: 3 (50% of implementation commits)
  - `062abd3` — Codex review: race condition fix, non-fatal audit, revision dirty state (+99/-47)
  - `9ae6bbc` — Access controls and approval workflow improvements (+65/-30)
  - `4c52095` — BMAD code review: 5 MEDIUM + 1 LOW fixes (+35/-19)
- Most-touched file: `server/routes.ts` (5 changes — highest churn, approval transaction logic)
- High-churn files: `ReviewQueue.tsx` (4 changes), `Layout.tsx` (4 changes), `ProposeTerm.tsx` (3 changes)
- Fix-to-feature ratio: ~50% (higher than Epic 5's 12.5%, but acceptable given state machine complexity)

### Commit Patterns

- **Batch implementation pattern**: All 4 stories implemented in a single commit (ef6e50c) — aggressive batching with 14 files changed
- **Multi-round review fixes**: 3 subsequent fix commits needed, indicating initial implementation missed some edge cases
- **Stabilization through iteration**: server/routes.ts required 5 touches to reach final state — approval transaction logic evolved through review feedback

## Codebase Health

- LSP errors: 2 (config-level: missing type definitions for `node` and `vite/client` — pre-existing, not code bugs)
- LSP warnings: 0
- TODO/FIXME/HACK markers: 0
- Net debt markers added: 0
- Overall: Clean codebase with zero new technical debt markers

## Code Review Findings

### Codex Review (First Pass)

| # | Finding | Severity | Status |
|---|---------|----------|--------|
| 1 | Race condition on concurrent approval — approve endpoint needed conditional UPDATE with status in WHERE clause | P1 | **Fixed** |
| 2 | Non-fatal audit — audit event writes need try/catch so failures don't return 500 | P2 | **Fixed** |
| 3 | Revision dirty state — formDirtyRef compared against wrong baseline | P2 | **Fixed** |

### BMAD Code Review (Second Pass)

| # | Finding | Severity | Status |
|---|---------|----------|--------|
| 1 | Missing aria-live on toast/status regions | MEDIUM | **Fixed** |
| 2 | Missing data-testid on badge count element | MEDIUM | **Fixed** |
| 3 | Missing Zod validation on resubmit endpoint body | MEDIUM | **Fixed** |
| 4 | Unsafe `as any` type cast in proposal handling | MEDIUM | **Fixed** |
| 5 | Inconsistent mock user names ("Current User" vs "Sarah Jenkins") | MEDIUM | **Fixed** |
| 6 | Missing timestamp tooltip on audit trail events | LOW | **Fixed** |

Overall Code Quality: B+ (3 P1/P2 + 5 MEDIUM + 1 LOW — all fixed through multi-round review)

## Lessons Learned

### Lesson 1: Complex State Machine Work Benefits from Upfront Race Condition Analysis

The approval workflow (pending -> approved/rejected/changes_requested -> resubmitted) had a P1 race condition that wasn't caught until the Codex review. Two approvers could simultaneously approve the same proposal because the initial implementation used a simple UPDATE without checking current status in the WHERE clause. The fix was to use `UPDATE proposals SET status = 'approved' WHERE id = ? AND status = 'pending'` inside a transaction, returning 409 if the row wasn't updated.

**Takeaway:** For any endpoint that transitions state (especially approval/rejection workflows), always include the expected current state in the WHERE clause. Analyze concurrent access scenarios during story creation, not just during code review.

### Lesson 2: Multi-Layer Code Review Catches Different Issue Categories

The Codex review caught runtime safety issues (race conditions, error handling). The BMAD review caught user experience issues (accessibility, validation, consistency). Neither review alone would have caught everything. The two-pass approach, while resulting in a higher fix-to-feature ratio, produced a more robust final product.

**Takeaway:** Multiple review passes with different lenses (runtime safety vs. UX/accessibility) are complementary, not redundant. Accept the higher fix-to-feature ratio as the cost of thoroughness.

### Lesson 3: Sequential Story Stacking Scales to 4 Stories

Epic 5 validated the pattern with 2 stories. Epic 6 proved it works with 4 stories building incrementally on the same files (ReviewQueue.tsx, routes.ts, storage.ts). Each story extended existing components and endpoints without conflicts. The pattern works because stories are implemented sequentially and each builds directly on the previous one's foundation.

**Takeaway:** Sequential story stacking is the preferred implementation approach for epics where stories share files. Implement in order, let each story build on the previous one's patterns.

### Lesson 4: Audit Trail as Normalized Table Pays Off

Story 6.3's `proposalEvents` table was designed as a proper normalized table (not a JSON column) with its own schema, enum types, and storage methods. This clean design made it easy for Story 6.4 to add "resubmitted" and "withdrawn" events, and for the timeline UI to render events chronologically with type-specific icons and colors.

**Takeaway:** When building audit/history features, invest in a normalized table design. The upfront cost is minimal compared to the flexibility gained for future event types and queries.

### Lesson 5: Bundle Technical Debt into Feature Stories

Epic 5's retrospective committed to consolidating carry-forward tech debt into a cleanup sprint. That didn't happen. The team decided in this retrospective to bundle debt items into relevant Epic 7 stories instead — e.g., fixing the principles storage bypass inside Story 7.3 (Principles Authoring Admin). This ensures cleanup happens naturally during feature work.

**Takeaway:** Tech debt consolidation sprints rarely happen. Bundling debt items into the specific feature stories that touch the affected code is more effective.

## Epic 5 Retrospective Follow-Through

| # | Action Item | Status | Evidence |
|---|------------|--------|----------|
| 1 | Update sprint-status.yaml with Epic 5 done | ✅ Done | sprint-status.yaml shows `epic-5: done` |
| 2 | Begin Epic 6 story creation | ✅ Done | All 4 story files created, implemented, completed |
| 3 | Review proposal schema for approval state machine fields | ✅ Done | Schema extended with `proposalEvents` table, `withdrawn` status, audit event types |
| 4 | Consolidate carry-forward tech debt to cleanup sprint | ❌ Not addressed | 5 items still carrying forward — team decided to bundle into Epic 7 stories instead |

**Follow-through rate:** 3 of 4 completed (75%), 1 strategically redirected (bundling into Epic 7 instead of separate sprint).

## Retrospective Discussion Summary

**Participants:** Bob (Scrum Master), Alice (Product Owner), Charlie (Senior Dev), Amelia (Developer), Dana (QA Engineer), Sally (UX Designer), User (Project Lead)

### What Went Well

- **Clean delivery**: 4/4 stories completed, all ACs met, 100% completion rate
- **Complete governance chain**: Propose (Epic 5) -> Review -> Approve/Reject/Revise -> Audit (Epic 6) — full lifecycle operational
- **Zero new tech debt markers**: Disciplined development with no TODOs, FIXMEs, or HACKs added
- **Audit trail design**: `proposalEvents` table was clean from day one, supporting all event types
- **Sequential story stacking**: 4 stories built incrementally with zero merge conflicts
- **Multi-layer review**: Caught all issues before production (3 P1/P2 + 6 MEDIUM/LOW)

### What Didn't Go Well

- **50% fix-to-feature ratio**: 3 fix commits for 3 implementation commits — acceptable for complexity but higher than ideal
- **Race condition missed in initial implementation**: P1 concurrent approval bug caught in review, not development
- **Accessibility built in review, not development**: aria-live, data-testid, timestamp tooltips all discovered in review rather than included in initial implementation
- **Mock user identity inconsistency**: "Current User" vs "Sarah Jenkins" vs "Current Approver" across components
- **Tech debt consolidation deferred again**: Carry-forward items from Epic 4 still not addressed (now planned for Epic 7 bundling)

### Key Decisions Made by User (Project Lead)

1. **Fix-to-feature ratio acceptable given complexity** — approval state machine and audit trail are inherently complex patterns
2. **Incremental accessibility improvement** — build in progressively rather than retrofit everything at once
3. **Bundle tech debt into Epic 7 stories** — more effective than separate cleanup sprint
4. **Mock auth for Epic 7** — continue with mock users/roles, real auth deferred to future epic
5. **Features first, then enforce** — implement admin features (7.1-7.4) then add role enforcement (7.5)

## Next Epic Preview: Epic 7 — Administration & Governance

### Overview

- **Stories**: 5 (all Medium)
  - 7.1 Category Management
  - 7.2 User Management
  - 7.3 Principles Authoring (Admin)
  - 7.4 System Settings & Governance Controls
  - 7.5 Role-Based Access Enforcement
- **Planned order**: 7.1 -> 7.2 -> 7.3 -> 7.4 -> 7.5 (features first, enforcement last)
- **Auth approach**: Mock auth (UI-level role enforcement, mock role context, shared permissions utility designed for future real auth)
- **Dependencies on Epic 6**: No direct blocking dependencies; Story 7.5 will retroactively protect Epic 6 endpoints

### Key Architectural Decisions

- **Mock role context pattern**: React context for client-side role, server middleware convention for API — designed so real auth can swap the identity source later
- **Story 7.5 as capstone**: Build admin features first, then wrap with role enforcement
- **Tech debt bundling**: Principles storage bypass fixed in 7.3, useSearch() hook extracted in 7.3's term linking

### Risks

- Auth infrastructure gap — real auth still deferred; mock patterns must be designed for clean migration
- Admin UI patterns are new territory — no reusable admin table/form components exist yet
- Story 7.5 (Role-Based Access) scope could expand if permission matrix edge cases emerge

## Outstanding Tech Debt

| # | Item | Severity | Source | Target |
|---|------|----------|--------|--------|
| 1 | `GET /api/principles` bypasses storage layer | MEDIUM | Epic 4 | Bundle into Story 7.3 |
| 2 | Extract `useSearch()` hook for DRY | LOW | Epic 1 | Bundle into Story 7.3 |
| 3 | Replace `<a>` with `<Link>` in search CTAs | LOW | Epic 1 | Bundle into Epic 7 nav work |
| 4 | `PrincipleWithCount` type assertion | LOW | Epic 4 | Bundle into Story 7.3 |
| 5 | Toast `TOAST_REMOVE_DELAY` 1000000ms | LOW | Pre-existing | Bundle into first Epic 7 story |

## Action Items

| # | Action | Owner | Priority | Target |
|---|--------|-------|----------|--------|
| 1 | Create accessibility checklist for developer reference | Sally (UX Designer) | High | Before Story 7.1 |
| 2 | Design mock role context pattern (React context + server convention) | Charlie (Senior Dev) | High | Before Story 7.1 |
| 3 | Document all mock identity patterns across codebase | Charlie (Senior Dev) | Medium | Before Story 7.5 |
| 4 | Fix `GET /api/principles` storage bypass | Amelia (Developer) | Medium | During Story 7.3 |
| 5 | Extract `useSearch()` hook + fix `<a>` vs `<Link>` + fix PrincipleWithCount type + fix toast delay | Amelia (Developer) | Low | During Epic 7 stories |

## Preparation Tasks for Epic 7

### Critical (before epic starts)

- [ ] Establish mock role context pattern (React context + server middleware convention)
- [ ] Plan users table schema for Story 7.2

### Parallel (during early stories)

- [ ] Plan settings key-value store schema for Story 7.4
- [ ] Document mock user identity patterns across components for 7.5 migration
- [ ] Create accessibility checklist for developer reference

### Nice-to-have

- [ ] Admin layout component pattern (can be established in Story 7.1)
- [ ] Remaining carry-forward debt (bundled into stories)

## Critical Path

| # | Item | Owner | Must Complete By |
|---|------|-------|-----------------|
| 1 | Mock role context pattern design | Charlie (Senior Dev) | Before Story 7.1 |
| 2 | Principles storage bypass fix | Amelia (Developer) | Before Story 7.3 |

## Team Agreements

- Continue sequential story stacking pattern for Epic 7
- Build accessibility patterns in during development using checklist, not retrofitting in review
- Bundle carry-forward tech debt into relevant feature stories
- Use mock auth approach for Epic 7, with `shared/permissions.ts` designed for future real auth
- Implement admin features (7.1-7.4) first, then add role enforcement (7.5) as capstone

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | Verified via multi-round code review | E2E gap noted for Story 8.3 |
| Deployment | Running on platform | |
| Technical Health | Clean | 0 debt markers, 0 LSP code errors |
| Unresolved Blockers | None | |
| Code Quality | All review findings resolved | 3 P1/P2 + 6 MEDIUM/LOW — all fixed |
| Tech Debt Trend | Neutral | 0 new, 5 carry-forward bundled into Epic 7 |
| Git Health | Acceptable | 50% fix ratio for complex state machine; 3 high-churn files stabilized |

## Epic 6 Metrics Summary

| Metric | Value |
|--------|-------|
| Stories completed | 4 |
| Total ACs | ~50 (all satisfied) |
| New files created | 1 (MyProposals.tsx) |
| Files modified | 13 |
| Schema changes | 2 (proposalEvents table, withdrawn enum value) |
| Net lines changed | +945/-233 (across all commits) |
| Code review findings | 9 total (3 P1/P2, 5 MEDIUM, 1 LOW — all fixed) |
| Fix-to-feature ratio | 50% |
| Tech debt items | 0 new (5 carry-forward bundled into Epic 7) |
| LSP errors | 2 (config-level, pre-existing) |
| Tech debt markers | 0 TODOs, 0 FIXMEs, 0 HACKs |
