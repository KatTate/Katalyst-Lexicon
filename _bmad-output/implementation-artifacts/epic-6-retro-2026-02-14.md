# Epic 6: Review & Approve — Retrospective

Date: 2026-02-14
Facilitator: Bob (Scrum Master)
Epic: 6 — Review & Approve
Status: Complete (4 stories done — all 29 ACs met)

## Epic Summary

Epic 6 delivered the complete review and approval workflow for Katalyst Lexicon — enabling approvers to view a queue of pending proposals, review full proposal details (with inline diffs for edits), approve/reject/request changes with confirmation dialogs and required comments, and maintain a full audit trail of all decisions. The epic also introduced the proposer revision flow, allowing contributors to see reviewer feedback, revise their proposals, and resubmit or withdraw. A new "My Proposals" page gives proposers visibility into all their submissions and their status.

## Story Completion Profile

| Story | Size | ACs | Files Created | Files Modified | Notes |
|-------|------|-----|---------------|----------------|-------|
| 6.1 Proposal Review Queue | M | 8 | 0 | 2 | Refined existing ReviewQueue.tsx — oldest-first ordering, empty state copy, data-testid, document.title, aria-labels |
| 6.2 Proposal Review and Decision | L | 10 | 0 | 2 | AlertDialog confirmation (AR15), required comments for reject/request-changes, 409 race condition, db.transaction() atomicity |
| 6.3 Proposal Audit Trail | S | 4 | 0 | 5 | New proposalEvents table, event recording on all endpoints, timeline UI with color-coded events, fallback for legacy proposals |
| 6.4 Proposer Revision Flow | M | 7 | 1 | 7 | MyProposals.tsx page, revision mode in ProposeTerm, resubmit/withdraw endpoints, change detection, feedback banner |

## Git Commit Analysis

- Total implementation commits: ~12 (including process/status/merge commits)
- Fix/correction commits: 2 (~17% fix ratio — healthy)
- Key commits:
  - `ef6e50c` — Main implementation of all 4 stories (Stories 6.1-6.4)
  - `062abd3` — Codex review fixes (race condition, non-fatal audit, revision dirty state)
  - `4c52095` — Code review fixes, mark stories done
  - `9ae6bbc` — Access controls and approval workflow improvements
  - `2d177b5` — Review and approval workflow refinements
  - `e442b3a` — Proposal rejection test + cleanup
- Most-touched files:
  - `ProposeTerm.tsx` — 5 changes (revision mode layered incrementally)
  - `server/routes.ts` — 4 changes (endpoints added across stories)
  - `ReviewQueue.tsx` — 3 changes (refined across 6.1, 6.2, 6.3)
  - `Layout.tsx` — 3 changes (nav updates for My Proposals)
- New files created: 1 (`MyProposals.tsx`)
- Merge PRs: 2 (story implementation + code review)

## Codebase Health

- LSP errors: 0
- LSP warnings: 0
- TODO/FIXME/HACK markers: 0
- Net debt markers added: 0

## Lessons Learned

### Lesson 1: Forward-Looking Enum Design Saves Migration Steps

Story 6.3 included `withdrawn` in the `proposalEventTypeEnum` even though it wasn't needed until Story 6.4. This meant Story 6.4 didn't need a separate schema migration for event types — only the `proposalStatusEnum` needed updating. Planning enums to include upcoming values when you can see the full epic scope avoids unnecessary migration churn.

**Takeaway:** When defining enums for a multi-story epic, look ahead at all stories' requirements and include values that will be needed soon. This is safe because adding unused enum values has zero runtime cost.

### Lesson 2: Transaction Wrapping Resolves Known Architectural Gaps

The architecture doc flagged "No database transactions — Proposal approval is not atomic" as a known gap. Story 6.2 resolved this by wrapping the approve flow in `db.transaction()`. This was a deliberate, targeted fix for a documented gap rather than an emergency fix.

**Takeaway:** Document architectural gaps explicitly during planning. When the right story arrives, the fix is scoped and intentional rather than a scrambled reaction to a production bug.

### Lesson 3: Confirmation Dialogs with AR15 Protection Require Deliberate UX Choices

The approval confirmation dialog (AR15 — Enter does NOT confirm) was counterintuitive at first because approval is a "positive" action. But because approval atomically creates/updates a term, it's effectively irreversible. Setting `autoFocus` on the Cancel button was the correct UX pattern for destructive-consequence actions, even when the intent is positive.

**Takeaway:** Classify actions by their consequences (reversible vs. irreversible), not their intent (positive vs. negative), when deciding whether to require confirmation dialogs.

### Lesson 4: Sequential Story Stacking Scales to 4-Story Epics

Epic 5 proved this pattern with 2 stories. Epic 6 extended it to 4 stories modifying the same core files (ReviewQueue.tsx, routes.ts, storage.ts). Each story built cleanly on the previous one's work with no merge conflicts or coordination overhead. The key is strict sequential implementation — never parallel.

**Takeaway:** Sequential story stacking works well for epics up to at least 4 stories. The pattern breaks down only if stories need to be implemented in parallel by different developers.

### Lesson 5: Revision Mode Demonstrates Component Mode Extensibility

ProposeTerm.tsx now supports three modes: new, edit, and revision. Each mode was added incrementally without breaking previous modes. The key architectural pattern was URL-parameter-driven mode detection (`?reviseProposalId=`), which keeps the component's API surface clean and routing simple.

**Takeaway:** When a component needs multiple modes, use URL parameters for mode detection and conditional rendering for mode-specific UI. This avoids prop drilling and keeps the router clean.

## Epic 5 Retrospective Follow-Through

| # | Action Item | Status | Evidence |
|---|------------|--------|----------|
| 1 | Update sprint-status.yaml with Epic 5 done | ✅ Done | sprint-status.yaml shows `epic-5: done` |
| 2 | Begin Epic 6 story creation (6.1 Proposal Review Queue) | ✅ Done | All 4 stories created and completed |
| 3 | Review proposal schema for approval state machine fields | ✅ Done | 6.2 wrapped approve in transaction, 6.3 created proposalEvents table |
| 4 | Consolidate carry-forward tech debt (useSearch hook, `<a>` → `<Link>`, toast delay) | ⏳ Deferred | Not relevant to Epic 6 scope — carry-forward to cleanup sprint |

**Follow-through rate:** 3 of 4 completed, 1 appropriately deferred (not relevant to Epic 6).

### Epic 5 Team Agreements Applied

| Agreement | Applied? | Evidence |
|-----------|----------|----------|
| Sequential story stacking | ✅ Yes | 4 stories built sequentially: 6.1→6.2→6.3→6.4 |
| Document dual-track patterns in dev notes | ✅ Yes | Story 6.4 dev notes reference dual-track change detection |
| Use ref-based dirty tracking for navigation guards | ✅ Yes | Story 6.4 reused formDirtyRef pattern for revision mode |
| Carry forward useSearch hook and `<a>` → `<Link>` fixes | ⏳ Deferred | Remain as carry-forward tech debt |

## Retrospective Discussion Summary

**Participants:** Bob (Scrum Master), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), User (Project Lead)

Bob (Scrum Master): "Epic 6 was architecturally significant — 4 stories, 29 ACs, 1 new page, 1 new table, 2 new API endpoints, approval state machine with transaction safety, and a full audit trail. The codebase is clean: zero LSP errors, zero debt markers."

Alice (Product Owner): "The review and approval workflow is complete. Approvers can review proposals, make decisions with required feedback, and proposers can revise and resubmit. This completes the governance loop that started in Epic 5."

Charlie (Senior Dev): "The transaction wrapping for approval atomicity was the most important architectural fix. We resolved a documented gap — the approve flow now atomically validates status, creates/updates the term, creates version history, updates proposal status, and records an audit event. If any step fails, everything rolls back."

Dana (QA Engineer): "The 409 race condition handling is solid. If two approvers try to act on the same proposal, the second one gets a clear error message and the page refreshes to show the current state."

Elena (Junior Dev): "The audit trail timeline UI turned out really well — color-coded events, chronological ordering, and it gracefully handles legacy proposals that don't have events by deriving a 'Submitted' entry from the proposal fields."

**User Assessment:** Epic 6 implementation is solid. Key discussion point: the plan for Epic 7 authentication needs to use Replit Auth with Google sign-in restricted to @katgroupinc.com domain, replacing the original Passport.js plan.

## Planning Decision: Auth Approach for Epic 7

**Decision made during retrospective:** Replace the original Passport.js + Google Workspace SSO plan with Replit Auth (OpenID Connect with Google sign-in) + @katgroupinc.com domain restriction.

**Key changes:**
- Auth handled by Replit Auth integration (manages OAuth plumbing, sessions, user records automatically)
- Domain restriction: server-side validation that email ends with `@katgroupinc.com` — non-matching emails rejected
- Auto-provisioning: users created automatically on first Google sign-in with default role "Member"
- No manual "Create User" flow — admins only manage roles (promote to Approver/Admin)
- First user to sign in gets auto-assigned "Admin" role (bootstrap)
- Replaces all hardcoded "Current User" / "Current Approver" strings with real identity

**Documents updated:**
- Architecture doc: External Dependencies, Known Gaps, API auth note
- PRD: Auth table, implementation note, moved SSO from "Out of Scope" to V1 (Epic 7)
- Epics doc: Story 7.2 (User Management) and Story 7.5 (Role-Based Access Enforcement) dev notes

## Team Agreements

- Continue sequential story stacking for multi-story epics
- Classify actions by consequences (reversible vs. irreversible) for confirmation dialog decisions
- Plan enums to include upcoming values when full epic scope is visible
- Document architectural gaps explicitly — resolve them when the right story arrives
- Use URL parameters for component mode detection (new/edit/revision pattern)
- Carry forward `useSearch()` hook extraction, `<a>` → `<Link>` fixes, and toast delay to cleanup sprint

## Readiness Assessment for Next Epic

### Epic 7: Administration & Governance (5 stories: 7.1-7.5)

- **Status:** backlog
- **Dependencies:** No hard dependencies on other epics
- **Stories:**
  - 7.1 Category Management — CRUD with reorder, delete protection
  - 7.2 User Management — auto-provisioned users, role management (updated for Replit Auth)
  - 7.3 Principles Authoring — admin create/edit/archive with term linking
  - 7.4 System Settings and Governance Controls — settings toggles, auto-save
  - 7.5 Role-Based Access Enforcement — auth middleware, role matrix, nav filtering (updated for Replit Auth)
- **Key architectural territory:** Replit Auth integration, @katgroupinc.com domain restriction, role-based middleware, admin CRUD pages, settings system
- **Risk:** Medium-High. Auth integration touches every existing page (nav filtering, identity for proposals/reviews, permission checks). Story 7.5 is cross-cutting and will modify most existing page components.
- **Preparation needed:**
  - Install Replit Auth integration before starting Epic 7
  - Plan Story 7.5 carefully — it modifies the most existing code
  - Consider implementing 7.5 early (or even first) since auth identity is needed by 7.2 and other admin pages

## Outstanding Tech Debt

| # | Item | Severity | Source | When to Address |
|---|------|----------|--------|-----------------|
| 1 | `GET /api/principles` bypasses storage layer | MEDIUM | Epic 4 Finding 3 | Before storage layer refactoring |
| 2 | Extract `useSearch()` hook for DRY | LOW | Epic 1 carry-forward | Cleanup sprint |
| 3 | Replace `<a>` with `<Link>` in search CTAs | LOW | Epic 1 carry-forward | Cleanup sprint |
| 4 | `PrincipleWithCount` type assertion | LOW | Epic 4 Finding 2 | When updating API client types |
| 5 | Toast TOAST_REMOVE_DELAY 1000000ms | LOW | Pre-existing | Cleanup sprint |

## Action Items

| # | Action | Priority | When |
|---|--------|----------|------|
| 1 | Update sprint-status.yaml with Epic 6 retro done | High | Now |
| 2 | Install Replit Auth integration | High | Before Epic 7 development |
| 3 | Plan Epic 7 story order (consider 7.5 early for auth foundation) | Medium | Sprint planning |
| 4 | Consolidate carry-forward tech debt into cleanup sprint | Low | After Epic 7 |

## Epic 6 Metrics Summary

| Metric | Value |
|--------|-------|
| Stories completed | 4 |
| Total ACs | 29 (all satisfied) |
| New pages created | 1 (MyProposals.tsx) |
| New tables created | 1 (proposalEvents) |
| New API endpoints | 2 (resubmit, withdraw) |
| Files modified | ~10 across all stories |
| Code review findings | Codex review caught 3 issues (race condition, non-fatal audit, dirty state) — all fixed |
| LSP errors/warnings | 0 / 0 |
| Tech debt markers added | 0 |
| Fix-to-feature commit ratio | ~17% (healthy) |
| Carry-forward tech debt | 5 items (unchanged from Epic 5) |
